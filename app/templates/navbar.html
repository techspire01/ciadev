{% load static %}
{% load custom_filters %}

  <!-- Hidden Google Translate Element -->
  <div id="google_translate_element" style="display: none;"></div>
  <!-- Navbar -->
  <nav class="bg-yellow-50 border-b-2 border-yellow-200 fixed-header shadow-md" style="background-color: #fffaed !important;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between py-2">
        <!-- Left Side: Login + Search -->
        <div class="flex items-center space-x-4 order-1">
         <!-- Login Button -->
          {% if user.is_authenticated %}
            <!-- Profile Icon with Initials -->
            <div class="relative group">
              <a href="{% url 'profile' %}" class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold text-sm focus:outline-none hover:bg-orange-600 transition-colors">
                {{ user.get_full_name|default:user.email|slice:":1"|upper }}
              </a>
              <div class="absolute hidden group-hover:block bg-white text-gray-700 mt-2 w-48 rounded shadow-lg z-[9999] border border-orange-300">
                <a href="{% url 'profile' %}" class="block px-4 py-2 hover:bg-orange-50 text-gray-800 font-medium">
                  <i class="fas fa-user mr-2 text-orange-600"></i>Profile
                </a>
                <a href="{% url 'logout' %}" class="block px-4 py-2 hover:bg-red-50 text-red-600 font-medium border-t border-gray-200">
                  <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
              </div>
            </div>
          {% else %}
            <a
              href="{% url 'login' %}"
              class="flex items-center space-x-2 text-orange-700 hover:text-orange-900 px-3 py-1 transition text-sm font-medium"
            >
              <i class="fas fa-user"></i>
              <span>Login</span>
            </a>
          {% endif %}
          <!-- Search Bar -->
          <div class="relative hidden md:block">
            <input
              type="text"
              id="searchInputDesktop"
              placeholder="Search..!!"
              class="w-32 py-1.5 pl-3 pr-10 rounded-full text-[#000000] bg-[#FFF9E5] border-2 border-[#fbbf24] shadow-md focus:outline-none focus:ring-2 focus:ring-yellow-600 focus:border-transparent search-box text-sm"
            />
            <button
              class="absolute right-1 top-0 bottom-0 text-yellow-700 hover:text-yellow-800 transition-colors duration-200 flex items-center justify-center pr-3 pl-2"
              title="Search"
              type="button"
            >
              <i class="fas fa-search"></i>
            </button>
            <div id="searchResultsDesktop" class="absolute top-full left-0 right-0 mt-1 bg-white rounded-md shadow-lg border border-gray-300 z-60 max-h-80 overflow-y-auto hidden"></div>
          </div>
        </div>


        <!-- Center: Logo -->
        <a href="{% url 'index' %}" class="flex items-center space-x-2 order-2 mx-auto px-6">
          <img loading="lazy"
            src="{% static 'images/CIA logo.png' %}"
            alt="CIA logo"
            class="h-8 rounded-lg logo-black-filter"
          />
          <span class="text-lg font-bold text-orange-800">CIA<span class="text-orange-600">next</span></span>
        </a>

        <!-- Right Side: Navigation + Language - Added margin -->
        <div class="hidden lg:flex items-center space-x-6 order-3 ml-4">
          <a
            href="{% url 'index' %}"
            class="text-orange-800 hover:text-orange-600 font-medium transition text-sm"
            >Home</a>
          <a
            href="{% url 'about' %}"
            class="text-orange-800 hover:text-orange-600 font-medium transition text-sm"
            >About Us</a
          >
          <a
            href="{% url 'dashboard' %}"
            class="text-orange-800 hover:text-orange-600 font-medium transition text-sm"
            >Career@CIA</a>
          <a
            href="{% url 'cia_networks' %}"
            class="text-orange-800 hover:text-orange-600 font-medium transition text-sm"
            >CIA Networks</a>
          <!-- Language Translation Buttons -->
          <div class="flex items-center space-x-1">
            <button id="translate-en" class="translate-btn px-2 py-0.5 text-xs font-medium text-white bg-yellow-500 rounded-md hover:bg-yellow-600 transition active shadow-md">EN</button>
            <button id="translate-ta" class="translate-btn px-2 py-0.5 text-xs font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition shadow-md">TA</button>
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <div class="lg:hidden order-3 flex items-center space-x-2">
          <button id="mobileMenuBtn" class="relative p-2 text-orange-800 hover:text-orange-600 transition-all duration-300 focus:outline-none">
            <div class="space-y-1">
              <span class="hamburger-line block w-6 h-0.5 bg-current transition-all duration-300"></span>
              <span class="hamburger-line block w-6 h-0.5 bg-current transition-all duration-300"></span>
              <span class="hamburger-line block w-6 h-0.5 bg-current transition-all duration-300"></span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation Menu -->
    <div id="mobileMenu" class="lg:hidden hidden">
      <!-- Mobile Menu Overlay -->
      <div class="mobile-menu-overlay fixed inset-0 bg-black bg-opacity-0 transition-all duration-300 pointer-events-none z-[9999]"></div>
      
      <div class="mobile-panel">
        <!-- Close Button Header (Sticky) -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-white sticky top-0 z-50">
          <h3 class="text-lg font-bold text-gray-800">Menu</h3>
          <button id="closeMobileMenu" type="button" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <!-- Mobile Menu Content -->
        <div class="flex-1 overflow-y-auto p-4">
          <!-- User Profile Section -->
          <div class="mb-6">
              {% if user.is_authenticated %}
                <div class="flex items-center space-x-3 p-3 bg-orange-100 rounded-lg">
                  <div class="w-12 h-12 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold text-lg">
                    {{ user.get_full_name|default:user.email|slice:":1"|upper }}
                  </div>
                  <div class="flex-1">
                    <p class="font-semibold text-gray-800">{{ user.get_full_name|default:user.email }}</p>
                    <p class="text-sm text-gray-600">{{ user.email }}</p>
                  </div>
                </div>
                <div class="mt-3">
                  <a href="{% url 'logout' %}" class="flex items-center space-x-2 w-full px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                  </a>
                </div>
              {% else %}
                <a href="{% url 'login' %}" class="flex items-center space-x-2 w-full px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition">
                  <i class="fas fa-user"></i>
                  <span>Login / Sign Up</span>
                </a>
              {% endif %}
            </div>

            <!-- Mobile Search Bar -->
            <div class="relative mb-6 z-50">
              <input
                type="text"
                id="searchInputMobile"
                placeholder="Search..!!"
                class="w-full py-1.5 pl-3 pr-10 rounded-full text-[#000000] bg-[#FFF9E5] border-2 border-[#fbbf24] shadow-md focus:outline-none focus:ring-2 focus:ring-yellow-600 focus:border-transparent search-box text-sm"
              />
              <button
                class="absolute right-1 top-0 bottom-0 text-yellow-700 hover:text-yellow-800 transition-colors duration-200 flex items-center justify-center pr-3 pl-2"
                title="Search"
                type="button"
              >
                <i class="fas fa-search"></i>
              </button>
              <div id="searchResultsMobile" class="absolute top-full left-0 right-0 mt-1 bg-white rounded-md shadow-lg border border-gray-300 z-[9999] max-h-80 overflow-y-auto hidden"></div>
            </div>

            <!-- Navigation Links -->
            <nav class="space-y-1">
              <a href="{% url 'index' %}" class="flex items-center space-x-3 px-3 py-2 text-sm text-black hover:text-orange-700 hover:bg-orange-100 rounded-lg transition">
                <i class="fas fa-home w-5"></i>
                <span class="font-medium">Home</span>
              </a>
              <a href="{% url 'about' %}" class="flex items-center space-x-3 px-3 py-2 text-sm text-black hover:text-orange-700 hover:bg-orange-100 rounded-lg transition">
                <i class="fas fa-info-circle w-5"></i>
                <span class="font-medium">About</span>
              </a>
              <a href="{% url 'dashboard' %}" class="flex items-center space-x-3 px-3 py-2 text-sm text-black hover:text-orange-700 hover:bg-orange-100 rounded-lg transition">
                <i class="fas fa-briefcase w-5"></i>
                <span class="font-medium">Career@CIA</span>
              </a>
              <a href="{% url 'cia_networks' %}" class="flex items-center space-x-3 px-3 py-2 text-sm text-black hover:text-yellow-700 hover:bg-yellow-50 rounded-lg transition">
                <i class="fas fa-building w-5"></i>
                <span class="font-medium">CIA Networks</span>
              </a>
              {% if user.is_authenticated %}
              <a href="{% url 'profile' %}" class="flex items-center space-x-3 px-3 py-2 text-sm text-black hover:text-orange-700 hover:bg-orange-100 rounded-lg transition">
                <i class="fas fa-user-circle w-5"></i>
                <span class="font-medium">My Profile</span>
              </a>
              {% endif %}
            </nav>
              
          <!-- Mobile Menu Footer -->
          <div class="border-t border-gray-200 p-4">
            <!-- Language Selector -->
            <div class="mb-4">
              <div id="mobileLanguageToggle" class="flex items-center justify-between w-full px-3 py-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                <div class="flex items-center space-x-2">
                  <img loading="lazy" src="https://cdn.builder.io/api/v1/image/assets%2F8b4537dd3fc94785bf1c6169a3c80769%2Fe2eef99b80e945699b2f2503b5a83ffa?format=webp&width=800" 
                      alt="Language" 
                      class="w-5 h-5">
                  <span class="font-medium">Language</span>
                </div>
                <!-- Language toggle (desktop version embedded here) -->
                <div class="flex items-center space-x-1">
                  <button id="translate-en-mobile" 
                          class="translate-btn px-2 py-0.5 text-xs font-medium text-orange-700 bg-white rounded-md hover:bg-yellow-100 transition active">
                    EN
                  </button>
                  <button id="translate-ta-mobile" 
                          class="translate-btn px-2 py-0.5 text-xs font-medium text-white bg-orange-700 border border-orange-800 rounded-md hover:bg-orange-800 transition">
                    TA
                  </button>
                </div>
              </div>
            </div>


            <!-- Contact Info -->
            <div class="text-center text-sm text-gray-500">
              <p>&copy; 2025 CIA MachineryHub</p>
              <p>All rights reserved</p>
            </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Google Translate Setup -->
  <script>
  // Load Google Translate immediately
  (function() {
    const gtScript = document.createElement('script');
    gtScript.src = "//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
    document.body.appendChild(gtScript);
  })();

  let translateElement = null;

  function googleTranslateElementInit() {
    translateElement = new google.translate.TranslateElement({
      pageLanguage: 'en',
      includedLanguages: 'en,ta',
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
      autoDisplay: false
    }, 'google_translate_element');

    // Wait a bit for the widget to fully initialize
    setTimeout(() => {
      console.log('Google Translate initialized');
    }, 1000);
  }

  // --- LANGUAGE SWITCH LOGIC ---
  function setLanguage(lang) {
    if (translateElement && typeof google !== 'undefined' && google.translate) {
      try {
        // Try to use Google Translate API directly
        const translateInstance = google.translate.TranslateElement.getInstance();
        if (translateInstance) {
          translateInstance.setLang(lang);
          console.log('Language set to:', lang);
          return;
        }
      } catch (e) {
        console.warn('Direct API call failed, using cookie method:', e);
      }
    }

    // Fallback: Set cookies and reload
    const cookieValue = lang === 'en' ? '/en/en' : '/en/' + lang;
    document.cookie = 'googtrans=' + cookieValue + ';path=/;max-age=31536000';
    document.cookie = 'googtrans=' + cookieValue + ';path=/;domain=' + window.location.hostname + ';max-age=31536000';

    // Force reload to apply translation
    setTimeout(() => {
      window.location.reload();
    }, 200);
  }

  function attachTranslateHandlers() {
    const btns = [
      '#translate-en', '#translate-ta',
      '#translate-en-mobile', '#translate-ta-mobile'
    ];
    btns.forEach(id => {
      const el = document.querySelector(id);
      if (el) {
        // Remove existing listeners to avoid duplicates
        el.onclick = null;
        el.addEventListener('click', (e) => {
          e.preventDefault();
          const lang = id.includes('ta') ? 'ta' : 'en';
          console.log('Button clicked:', id, 'Language:', lang);
          setLanguage(lang);
          updateLanguageButtonStyles(lang);
        });
      }
    });
  }

  function updateLanguageButtonStyles(lang) {
    const enBtns = ['#translate-en', '#translate-en-mobile'];
    const taBtns = ['#translate-ta', '#translate-ta-mobile'];
    
    if (lang === 'en') {
      // EN is active - yellow, TA is inactive - gray
      enBtns.forEach(id => {
        const btn = document.querySelector(id);
        if (btn) {
          btn.className = 'translate-btn px-3 py-1 text-sm font-medium text-white bg-yellow-500 rounded-md hover:bg-yellow-600 transition active shadow-md';
        }
      });
      taBtns.forEach(id => {
        const btn = document.querySelector(id);
        if (btn) {
          btn.className = 'translate-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition shadow-md';
        }
      });
    } else {
      // TA is active - orange, EN is inactive - gray
      taBtns.forEach(id => {
        const btn = document.querySelector(id);
        if (btn) {
          btn.className = 'translate-btn px-3 py-1 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 transition active shadow-md';
        }
      });
      enBtns.forEach(id => {
        const btn = document.querySelector(id);
        if (btn) {
          btn.className = 'translate-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition shadow-md';
        }
      });
    }
  }

  // run once after DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    // Initial attachment
    attachTranslateHandlers();
    
    // Initialize button styles based on saved language
    const savedLang = localStorage.getItem('selectedLanguage') || 'en';
    updateLanguageButtonStyles(savedLang);

    // ðŸ§  Watch for new buttons in mobile menu after toggle
    const observer = new MutationObserver(() => attachTranslateHandlers());
    observer.observe(document.body, { childList: true, subtree: true });

    // Mobile menu toggle functionality
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileMenuOverlay = mobileMenu ? mobileMenu.querySelector('.mobile-menu-overlay') : null;
    
    function closeMenu() {
      if (mobileMenu) {
        mobileMenu.classList.remove('show');
        mobileMenu.classList.add('hidden');
      }
      if (mobileMenuBtn) {
        const lines = mobileMenuBtn.querySelectorAll('.hamburger-line');
        lines.forEach(line => line.classList.remove('active'));
      }
    }
    
    if (mobileMenuBtn && mobileMenu) {
      mobileMenuBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const isHidden = mobileMenu.classList.contains('hidden');
        if (isHidden) {
          mobileMenu.classList.remove('hidden');
          setTimeout(() => {
            mobileMenu.classList.add('show');
          }, 10);
        } else {
          closeMenu();
        }
        
        // Toggle hamburger animation
        const lines = mobileMenuBtn.querySelectorAll('.hamburger-line');
        lines.forEach(line => line.classList.toggle('active'));
      });

      // Close menu when a link is clicked
      const menuLinks = mobileMenu.querySelectorAll('a');
      menuLinks.forEach(link => {
        link.addEventListener('click', () => {
          closeMenu();
        });
      });

      // Close menu when clicking on overlay
      if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', (e) => {
          e.stopPropagation();
          closeMenu();
        });
      }
    }

    // Close button handler
    document.addEventListener('click', (e) => {
      if (e.target.closest('#closeMobileMenu')) {
        e.preventDefault();
        e.stopPropagation();
        closeMenu();
        return false;
      }
    }, true);

    // ðŸ• re-run binding after mobile menu toggle delay
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', () => {
        setTimeout(attachTranslateHandlers, 400);
      });
    }

    // ===== SEARCH FUNCTIONALITY =====
    // Desktop Search
    const desktopSearch = document.getElementById('searchInputDesktop');
    const desktopResults = document.getElementById('searchResultsDesktop');

    if (desktopSearch && desktopResults) {
      desktopSearch.addEventListener('input', async (e) => {
        const query = e.target.value.trim();

        if (query.length < 2) {
          desktopResults.classList.add('hidden');
          return;
        }

        try {
          const response = await fetch(`/api/search/?q=${encodeURIComponent(query)}`);
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            desktopResults.innerHTML = data.results.map(result => {
              const title = result.title || result.name || '';
              const desc = result.description || '';
              // If search result is a job or internship, link to the details page with id and type
              let url = result.url || ('/search/?q=' + encodeURIComponent(title));
              try {
                if ((result.type === 'job' || result.type === 'internship') && result.id) {
                  const detailsBase = "{% url 'details' %}";
                  url = detailsBase + '?id=' + encodeURIComponent(result.id) + '&type=' + encodeURIComponent(result.type);
                }
              } catch (e) {
                // If template tag fails for any reason, fall back to provided url
                console.warn('Could not build details url, falling back', e);
              }
              const meta = (result.company ? result.company : result.category) || '';
              const location = result.location ? (' â€¢ ' + result.location) : '';
              const badge = result.type ? `<span class="text-xs font-semibold text-white px-2 py-0.5 rounded ml-2 ${result.type==='job' ? 'bg-green-600' : result.type==='internship' ? 'bg-blue-600' : 'bg-gray-600'}">${result.type}</span>` : '';
              return `
                <a href="${url}" class="block px-4 py-2 hover:bg-yellow-50 border-b border-gray-200 last:border-b-0">
                  <div class="font-medium text-gray-800">${title} ${badge}</div>
                  <div class="text-xs text-gray-600">${meta}${location}${desc ? ' â€” ' + desc.replace(/(<([^>]+)>)/ig, '').slice(0,140) : ''}</div>
                </a>
              `;
            }).join('');
            desktopResults.classList.remove('hidden');
          } else {
            desktopResults.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No results found</div>';
            desktopResults.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Search error:', error);
          desktopResults.innerHTML = '<div class="px-4 py-2 text-red-500 text-sm">Error searching</div>';
          desktopResults.classList.remove('hidden');
        }
      });

      desktopSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = desktopSearch.value.trim();
          if (query) {
            window.location.href = `/search/?q=${encodeURIComponent(query)}`;
          }
        }
      });
    }

    // Mobile Search
    const mobileSearch = document.getElementById('searchInputMobile');
    const mobileResults = document.getElementById('searchResultsMobile');

    if (mobileSearch && mobileResults) {
      mobileSearch.addEventListener('input', async (e) => {
        const query = e.target.value.trim();

        if (query.length < 2) {
          mobileResults.classList.add('hidden');
          return;
        }

        try {
          const response = await fetch(`/api/search/?q=${encodeURIComponent(query)}`);
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            mobileResults.innerHTML = data.results.map(result => {
              const title = result.title || result.name || '';
              const desc = result.description || '';
              // If search result is a job or internship, link to the details page with id and type
              let url = result.url || ('/search/?q=' + encodeURIComponent(title));
              try {
                if ((result.type === 'job' || result.type === 'internship') && result.id) {
                  const detailsBase = "{% url 'details' %}";
                  url = detailsBase + '?id=' + encodeURIComponent(result.id) + '&type=' + encodeURIComponent(result.type);
                }
              } catch (e) {
                // If template tag fails for any reason, fall back to provided url
                console.warn('Could not build details url, falling back', e);
              }
              const meta = (result.company ? result.company : result.category) || '';
              const location = result.location ? (' â€¢ ' + result.location) : '';
              const badge = result.type ? `<span class="text-xs font-semibold text-white px-2 py-0.5 rounded ml-2 ${result.type==='job' ? 'bg-green-600' : result.type==='internship' ? 'bg-blue-600' : 'bg-gray-600'}">${result.type}</span>` : '';
              return `
                <a href="${url}" class="block px-4 py-2 hover:bg-yellow-50 border-b border-gray-200 last:border-b-0">
                  <div class="font-medium text-gray-800">${title} ${badge}</div>
                  <div class="text-xs text-gray-600">${meta}${location}${desc ? ' â€” ' + desc.replace(/(<([^>]+)>)/ig, '').slice(0,140) : ''}</div>
                </a>
              `;
            }).join('');
            mobileResults.classList.remove('hidden');
          } else {
            mobileResults.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No results found</div>';
            mobileResults.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Search error:', error);
          mobileResults.innerHTML = '<div class="px-4 py-2 text-red-500 text-sm">Error searching</div>';
          mobileResults.classList.remove('hidden');
        }
      });

      mobileSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = mobileSearch.value.trim();
          if (query) {
            window.location.href = `/search/?q=${encodeURIComponent(query)}`;
          }
        }
      });
    }

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.relative') && !e.target.closest('#searchInputDesktop') && !e.target.closest('#searchInputMobile')) {
        if (desktopResults) desktopResults.classList.add('hidden');
        if (mobileResults) mobileResults.classList.add('hidden');
      }
    });
  });
  </script>
