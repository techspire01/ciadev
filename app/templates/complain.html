{% extends 'base.html' %}
{% load static %}

{% block title %}Submit a Complaint â€” CIAnext{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-10px);
        }
    }

    @keyframes floatWave {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }

    @keyframes fadeInOverlay {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    #login-overlay {
        animation: fadeInOverlay 0.3s ease-out;
    }

    .complaint-hero-title {
        animation: slideDown 0.8s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .complaint-card {
        background: linear-gradient(135deg, #FFFFFF 0%, #FAFAF8 50%, #F5F3F0 100%);
        border: 3px solid #d97706;
        transition: all 0.3s ease;
    }

    .complaint-card:hover {
        box-shadow: 0 20px 50px rgba(217, 119, 6, 0.2);
        transform: translateY(-5px);
    }

    .form-input {
        border: 2px solid #d97706;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        border-color: #ea580c;
        box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        outline: none;
    }

    .submit-btn {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        transition: all 0.3s ease;
    }

    .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(217, 119, 6, 0.35);
    }

    .alert-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-left: 4px solid #10b981;
    }

    .alert-error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-left: 4px solid #ef4444;
    }
</style>
{% endblock %}

{% block content %}
{% if not user.is_authenticated %}
<!-- Login Required Modal Overlay -->
<div id="login-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm" style="display: flex;">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 text-center transform transition-all duration-300 relative" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 50%, #ea580c 100%); color: white; animation: slideUp 0.3s ease-out;">
        <!-- Close Button -->
        <button id="close-popup" type="button" class="absolute top-4 right-4 text-white hover:text-gray-200 transition-colors cursor-pointer bg-white/10 rounded-full w-8 h-8 flex items-center justify-center hover:bg-white/20" title="Close">
            <i class="fas fa-times text-xl"></i>
        </button>
        <div class="mb-4">
            <i class="fas fa-lock text-6xl opacity-90" style="animation: bounce 2s infinite;"></i>
        </div>
        <h2 class="text-2xl font-bold mb-4">Access Restricted</h2>
        <p class="text-lg mb-6 leading-relaxed">Please login to submit a complaint and get assistance.</p>
        <a href="{% url 'login' %}" id="login-btn" class="inline-flex items-center justify-center bg-white text-orange-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 hover:text-orange-700 transition-all duration-300 shadow-lg cursor-pointer w-full">
            <i class="fas fa-sign-in-alt mr-2"></i>Login Now
        </a>
    </div>
</div>
{% else %}
<!-- Hero Section -->
<section class="complaint-hero relative overflow-hidden py-20 md:py-32" style="background-image: url('https://images.unsplash.com/photo-1516321318423-f06f70d504f0?w=1920&q=80'); background-attachment: fixed; background-position: center; background-repeat: no-repeat; background-size: cover;">
    <!-- Multi-layer gradient overlay -->
    <div class="absolute inset-0 bg-gradient-to-br from-blue-950/85 via-blue-900/80 to-blue-800/85"></div>
    
    <!-- Animated colored blobs -->
    <div class="absolute inset-0 opacity-40">
        <div class="absolute top-10 left-10 w-80 h-80 bg-gradient-to-br from-blue-500 to-blue-400 rounded-full mix-blend-screen filter blur-3xl animate-blob"></div>
        <div class="absolute top-1/3 right-20 w-96 h-96 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full mix-blend-screen filter blur-3xl animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-20 left-1/3 w-80 h-80 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-full mix-blend-screen filter blur-3xl animate-blob animation-delay-4000"></div>
    </div>

    <div class="container mx-auto px-4 text-center relative z-10">
        <div class="max-w-4xl mx-auto">
            <div class="mb-8 inline-block">
                <i class="fas fa-headset text-7xl opacity-95 text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-200 to-cyan-200"></i>
            </div>

            <h1 class="complaint-hero-title text-5xl md:text-7xl font-black mb-6 leading-tight text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 via-blue-100 to-cyan-200">
                Submit Your Complaint
            </h1>

            <p class="text-xl md:text-2xl text-white/95 leading-relaxed drop-shadow-lg mb-8">
                We value your feedback. Let us know about any issues you've encountered and we'll work to resolve them quickly.
            </p>

            <div class="flex items-center justify-center gap-3 mb-8">
                <div class="h-1.5 w-12 bg-gradient-to-r from-transparent to-cyan-300 rounded-full"></div>
                <div class="w-3 h-3 rounded-full bg-gradient-to-b from-cyan-300 to-blue-500"></div>
                <div class="h-1.5 w-12 bg-gradient-to-l from-transparent to-blue-300 rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- Animated bottom wave -->
    <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-white via-blue-100/30 to-transparent opacity-20"></div>
</section>

<!-- Complaint Form Section -->
<section class="py-16 bg-gradient-to-b from-gray-50 via-blue-50 to-cyan-50 relative overflow-hidden">
    <!-- Decorative background elements -->
    <div class="absolute -top-40 -left-40 w-80 h-80 bg-gradient-to-br from-blue-200/20 to-cyan-200/20 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-40 -right-40 w-80 h-80 bg-gradient-to-br from-cyan-200/20 to-blue-200/20 rounded-full blur-3xl"></div>

    <div class="container mx-auto px-4 relative z-10">
        <div class="max-w-3xl mx-auto">
            <!-- Success/Error Alert -->
            <div id="complaintAlert" class="hidden mb-8 p-6 rounded-2xl shadow-lg transform transition-all duration-300 animate-in fade-in slide-in-from-top-2">
                <div class="flex items-center gap-4">
                    <i id="alertIcon" class="fas fa-check-circle text-2xl"></i>
                    <div>
                        <p id="alertMessage" class="text-lg font-semibold"></p>
                        <p id="alertTime" class="text-sm opacity-80 mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- Complaint Form Card -->
            <div class="complaint-card rounded-3xl p-8 shadow-lg">
                <h2 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                    <i class="fas fa-exclamation-circle text-orange-600"></i>
                    Tell Us What Happened
                </h2>
                <p class="text-gray-600 mb-8">Your feedback helps us improve. Please describe the issue in detail.</p>

                <form id="complaintForm" class="space-y-6">
                    {% csrf_token %}

                    <!-- Complaint Text -->
                    <div>
                        <label for="complaintText" class="block text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-message text-orange-600"></i>
                            Your Complaint
                        </label>
                        <textarea
                            id="complaintText"
                            name="complaint"
                            rows="6"
                            class="form-input w-full p-4 rounded-xl resize-none placeholder-gray-400 text-gray-800"
                            placeholder="Please describe the issue you encountered, what happened, and when it occurred..."
                            required
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-2">Be as detailed as possible to help us understand and resolve the issue faster.</p>
                    </div>

                    <!-- Contact Number -->
                    <div>
                        <label for="complaintContact" class="block text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-phone text-orange-600"></i>
                            Contact Number (Optional)
                        </label>
                        <input
                            id="complaintContact"
                            name="contact_number"
                            type="tel"
                            class="form-input w-full p-4 rounded-xl placeholder-gray-400 text-gray-800"
                            placeholder="Your phone number for follow-up (optional)"
                        />
                        <p class="text-xs text-gray-500 mt-2">We'll use this to contact you if we need more information.</p>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex gap-4 pt-4">
                        <button
                            type="submit"
                            id="complaintSubmitBtn"
                            class="submit-btn flex-1 text-white px-6 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg"
                        >
                            <i class="fas fa-paper-plane"></i>
                            Submit Complaint
                        </button>
                        <button
                            type="reset"
                            class="flex-1 text-gray-700 px-6 py-4 rounded-xl font-bold text-lg border-2 border-gray-300 hover:bg-gray-100 transition-all duration-300"
                        >
                            <i class="fas fa-redo mr-2"></i>
                            Clear
                        </button>
                    </div>
                </form>
            </div>

            <!-- Info Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                <div class="complaint-card rounded-2xl p-6 text-center">
                    <div class="text-4xl text-orange-600 mb-3 flex justify-center">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3 class="font-bold text-gray-900 mb-2">Quick Response</h3>
                    <p class="text-sm text-gray-600">We aim to respond to all complaints within 24-48 hours.</p>
                </div>

                <div class="complaint-card rounded-2xl p-6 text-center">
                    <div class="text-4xl text-orange-600 mb-3 flex justify-center">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="font-bold text-gray-900 mb-2">Confidential</h3>
                    <p class="text-sm text-gray-600">Your complaint information is kept confidential and secure.</p>
                </div>

                <div class="complaint-card rounded-2xl p-6 text-center">
                    <div class="text-4xl text-orange-600 mb-3 flex justify-center">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="font-bold text-gray-900 mb-2">Resolution</h3>
                    <p class="text-sm text-gray-600">We work diligently to resolve every complaint fairly.</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle modal close button and outside clicks
    const closeBtn = document.getElementById('close-popup');
    const overlay = document.getElementById('login-overlay');

    if (closeBtn && overlay) {
        closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            overlay.style.display = 'none';
        });
    }

    // Login button handler
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn && overlay) {
        loginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            overlay.style.display = 'none';
            window.location.href = '{% url "login" %}';
        });
    }

    // Close overlay when clicking outside the modal
    if (overlay) {
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                overlay.style.display = 'none';
            }
        });
    }

    // Complaint form submission
    const form = document.getElementById('complaintForm');
    if (!form) return;

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const complaint = document.getElementById('complaintText').value.trim();
        const contact = document.getElementById('complaintContact').value.trim();
        const alertBox = document.getElementById('complaintAlert');
        const submitBtn = document.getElementById('complaintSubmitBtn');
        const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

        if (!complaint) {
            showAlert('Please enter your complaint.', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

        const formData = new URLSearchParams();
        formData.append('complaint', complaint);
        formData.append('contact_number', contact);

        fetch('{% url "submit_complaint" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: formData.toString()
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.json().then(err => { throw err; });
        })
        .then(data => {
            showAlert(data.message || 'Complaint submitted successfully!', 'success');
            form.reset();
            // Auto-hide alert after 5 seconds
            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 5000);
        })
        .catch(err => {
            console.error('Complaint submit error:', err);
            showAlert((err && err.error) ? err.error : 'Failed to submit. Please try again.', 'error');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Complaint';
        });
    });

    function showAlert(message, type) {
        const alertBox = document.getElementById('complaintAlert');
        const alertMessage = document.getElementById('alertMessage');
        const alertTime = document.getElementById('alertTime');
        const alertIcon = document.getElementById('alertIcon');

        alertMessage.textContent = message;
        
        // Get current time in correct format
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
        });
        alertTime.textContent = `Submitted at ${timeStr}`;

        if (type === 'success') {
            alertBox.className = 'mb-8 p-6 rounded-2xl shadow-lg transform transition-all duration-300 animate-in fade-in slide-in-from-top-2 alert-success';
            alertIcon.className = 'fas fa-check-circle text-2xl';
        } else {
            alertBox.className = 'mb-8 p-6 rounded-2xl shadow-lg transform transition-all duration-300 animate-in fade-in slide-in-from-top-2 alert-error';
            alertIcon.className = 'fas fa-exclamation-circle text-2xl';
        }
        alertBox.classList.remove('hidden');
    }
});
</script>
{% endblock %}
