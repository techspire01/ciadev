{% load static %}
<!-- Complaint modal partial -->
<div id="complaintModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg w-11/12 max-w-2xl p-6 shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Submit a Complaint</h3>
      <button id="closeComplaintModal" class="text-gray-600 hover:text-gray-800">âœ•</button>
    </div>
    <div id="complaintAlert" class="hidden mb-3 text-sm"></div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Complaint</label>
      <textarea id="complaintText" rows="4" class="mt-1 block w-full border rounded-md p-2" placeholder="Describe your complaint..."></textarea>
    </div>
    <div class="mt-3">
      <label class="block text-sm font-medium text-gray-700">Contact Number (optional)</label>
      <input id="complaintContact" type="text" class="mt-1 block w-full border rounded-md p-2" placeholder="Phone or WhatsApp number">
    </div>
    <div class="mt-4 flex justify-end">
      <button id="complaintCancel" class="mr-2 px-4 py-2 bg-gray-200 rounded">Cancel</button>
      <button id="complaintSubmitBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Submit</button>
    </div>
  </div>
</div>

<script>
(function(){
  function el(id){return document.getElementById(id)}
  var modal = el('complaintModal');
  var openBtns = document.querySelectorAll('#complaintBtn');
  var closeBtn = el('closeComplaintModal');
  var cancelBtn = el('complaintCancel');
  var submitBtn = el('complaintSubmitBtn');
  var alertBox = el('complaintAlert');

  function showModal(){ modal && modal.classList && modal.classList.remove('hidden'); modal && modal.classList && modal.classList.add('flex'); }
  function hideModal(){ if(modal){ modal.classList.add('hidden'); modal.classList.remove('flex'); } if(alertBox){ alertBox.classList.add('hidden'); alertBox.textContent=''; } if(el('complaintText')) el('complaintText').value=''; if(el('complaintContact')) el('complaintContact').value=''; }

  openBtns.forEach(function(b){ b && b.addEventListener('click', function(e){ e.preventDefault(); showModal(); }); });
  closeBtn && closeBtn.addEventListener('click', hideModal);
  cancelBtn && cancelBtn.addEventListener('click', hideModal);

  submitBtn && submitBtn.addEventListener('click', function(){
    var complaintEl = el('complaintText');
    var contactEl = el('complaintContact');
    var complaint = complaintEl ? complaintEl.value.trim() : '';
    var contact = contactEl ? contactEl.value.trim() : '';
    if(!complaint){
      if(alertBox){ alertBox.className = 'mb-3 text-sm text-red-700'; alertBox.textContent = 'Please enter your complaint.'; alertBox.classList.remove('hidden'); }
      return;
    }

    var formData = new URLSearchParams();
    formData.append('complaint', complaint);
    formData.append('contact_number', contact);

    fetch('{% url "submit_complaint" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: formData.toString()
    }).then(function(res){
      return res.json().then(function(j){ if(res.ok) return j; throw j; });
    }).then(function(data){
      if(alertBox){ alertBox.className = 'mb-3 text-sm text-green-700'; alertBox.textContent = data.message || 'Submitted successfully.'; alertBox.classList.remove('hidden'); }
      setTimeout(hideModal, 1400);
    }).catch(function(err){
      console.error('Complaint submit error', err);
      if(alertBox){ alertBox.className = 'mb-3 text-sm text-red-700'; alertBox.textContent = (err && err.error) ? err.error : 'Failed to submit.'; alertBox.classList.remove('hidden'); }
    });
  });
})();
</script>
