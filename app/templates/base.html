{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="CIA MachineryHub - Connect with machinery suppliers in Tamil Nadu">
    <meta name="theme-color" content="#fbbf24">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CIA Hub">
    <meta name="application-name" content="CIA MachineryHub">
    
    <title>{% block title %}CIA MachineryHub{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <link rel="apple-touch-icon" href="{% static 'images/CIA logo.png' %}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/CIA logo.png' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50">
    {% include 'navbar.html' %}

    <main>
        {% block content %}{% endblock %}
    </main>

    {% include 'footer.html' %}

    <script src="{% static 'js/script.js' %}"></script>
        <!-- Complaint Modal (hidden by default) -->
        <div id="complaintModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg w-11/12 max-w-2xl p-6 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Submit a Complaint</h3>
                    <button id="closeComplaintModal" class="text-gray-600 hover:text-gray-800">âœ•</button>
                </div>
                <div id="complaintAlert" class="hidden mb-3 text-sm"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Complaint</label>
                    <textarea id="complaintText" rows="4" class="mt-1 block w-full border rounded-md p-2" placeholder="Describe your complaint..."></textarea>
                </div>
                <div class="mt-3">
                    <label class="block text-sm font-medium text-gray-700">Contact Number (optional)</label>
                    <input id="complaintContact" type="text" class="mt-1 block w-full border rounded-md p-2" placeholder="Phone or WhatsApp number">
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="complaintCancel" class="mr-2 px-4 py-2 bg-gray-200 rounded">Cancel</button>
                    <button id="complaintSubmitBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Submit</button>
                </div>
            </div>
        </div>

        <script>
            (function(){
                function el(id){return document.getElementById(id)}
                var modal = el('complaintModal');
                var openBtns = document.querySelectorAll('#complaintBtn');
                var closeBtn = el('closeComplaintModal');
                var cancelBtn = el('complaintCancel');
                var submitBtn = el('complaintSubmitBtn');
                var alertBox = el('complaintAlert');

                function showModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
                function hideModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); alertBox.classList.add('hidden'); alertBox.textContent=''; el('complaintText').value=''; el('complaintContact').value=''; }

                openBtns.forEach(function(b){ b && b.addEventListener('click', function(e){ e.preventDefault(); showModal(); }); });
                closeBtn && closeBtn.addEventListener('click', hideModal);
                cancelBtn && cancelBtn.addEventListener('click', hideModal);

                submitBtn && submitBtn.addEventListener('click', function(){
                    var complaint = el('complaintText').value.trim();
                    var contact = el('complaintContact').value.trim();
                    if(!complaint){
                        alertBox.className = 'mb-3 text-sm text-red-700'; alertBox.textContent = 'Please enter your complaint.'; alertBox.classList.remove('hidden'); return;
                    }

                    var formData = new URLSearchParams();
                    formData.append('complaint', complaint);
                    formData.append('contact_number', contact);

                    fetch('{% url "submit_complaint" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: formData.toString()
                    }).then(function(res){
                        if(res.status === 201) return res.json();
                        return res.json().then(function(j){ throw j; });
                    }).then(function(data){
                        alertBox.className = 'mb-3 text-sm text-green-700'; alertBox.textContent = data.message || 'Submitted successfully.'; alertBox.classList.remove('hidden');
                        setTimeout(hideModal, 1500);
                    }).catch(function(err){
                        console.error('Complaint submit error', err);
                        alertBox.className = 'mb-3 text-sm text-red-700'; alertBox.textContent = (err && err.error) ? err.error : 'Failed to submit.'; alertBox.classList.remove('hidden');
                    });
                });
            })();

            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show your custom install button
                const installButton = document.getElementById('pwaInstallBtn');
                if (installButton) {
                    installButton.style.display = 'block';
                }
            });

            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('{% static "js/service-worker.js" %}').then(function(registration) {
                    console.log('Service Worker registered:', registration);
                }).catch(function(err) {
                    console.log('Service Worker registration failed:', err);
                });
            }
        </script>

        {% block extra_js %}{% endblock %}
</body>
</html>
